{% extends 'base.html' %}
{% load static %}
{% block title %}EDITAR PLAN DIARIO{% endblock %}
{% block content %}

<div class="container">
    <div class="section-title">
        <h2>
            <span>EDITAR PLAN</span>
            <span>DIARIO</span>
        </h2>
    </div>
    <form method="post">
        {% csrf_token %}
        
        <div class="tabset">
            <!-- Pestañas para los días -->
            {% for i in rango_dias %}
                <input type="radio" name="tabset" id="tab{{ i }}" 
                    aria-controls="dia{{ i }}" 
                    {% if forloop.first %}checked{% endif %}>
                <label for="tab{{ i }}">Día {{ i }}</label>
            {% endfor %}
        
            <div class="tab-panels">
                {% for i in rango_dias %}
                    <section id="dia{{ i }}" class="tab-panel">
                        <div class="main-container">
                            <div>
                                <div class="button-container">
                                    <button type="button" class="btn btn-success" onclick="agregarPlato('{{ tipo|lower }}', '{{ i }}')">Lista de platos</button>
                                </div>
                                <!-- Barra lateral con lista (oculta) -->
                                <div id="listaComidas{{ i }}" class="sidebar hidden">
                                    <input type="text" class="search-box" placeholder="Buscar alimento..." onkeyup="filterList()">
                                    <div class="food-list">
                                        {% for plato in platos %}
                                        <button type="button" class="food-item" onclick="seleccionarComida('{{ plato.nombre }}', '{{ i }}', '{{ plato.idplato }}')">
                                            {{ plato.nombre }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                                <!-- Barra lateral visible con categorías -->
                                <div class="sidebar">
                                    <input type="text" id="searchInput" class="search-box" placeholder="Buscar alimento..." onkeyup="filterList()">
                                    <div class="food-list">
                                        <!-- Desayuno -->
                                        <div class="category" onclick="toggleCategory(this)">
                                            <span class="toggle-arrow">▼</span>
                                            <span>Desayuno</span>
                                        </div>
                                        <ul>
                                            {% for plato in platos %}
                                                {% if plato.tipo == "desayuno" %}
                                                    <li class="plandiario-li">
                                                        <button type="button" class="food-item" onclick="abrirModalPlato('{{ plato.idplato }}', '{{ i }}', 'Desayuno')">
                                                            {{ plato.nombre }}
                                                        </button>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                        <!-- Almuerzo -->
                                        <div class="category" onclick="toggleCategory(this)">
                                            <span class="toggle-arrow">▼</span>
                                            <span>Almuerzo</span>
                                        </div>
                                        <ul>
                                            {% for plato in platos %}
                                                {% if plato.tipo == "almuerzo" %}
                                                    <li class="plandiario-li">
                                                        <button type="button" class="food-item" onclick="abrirModalPlato('{{ plato.idplato }}', '{{ i }}', 'Almuerzo')">
                                                            {{ plato.nombre }}
                                                        </button>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                        <!-- Merienda -->
                                        <div class="category" onclick="toggleCategory(this)">
                                            <span class="toggle-arrow">▼</span>
                                            <span>Merienda</span>
                                        </div>
                                        <ul>
                                            {% for plato in platos %}
                                                {% if plato.tipo == "merienda" %}
                                                    <li class="plandiario-li">
                                                        <button type="button" class="food-item" onclick="abrirModalPlato('{{ plato.idplato }}', '{{ i }}', 'Merienda')">
                                                            {{ plato.nombre }}
                                                        </button>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                        <!-- Cena -->
                                        <div class="category" onclick="toggleCategory(this)">
                                            <span class="toggle-arrow">▼</span>
                                            <span>Cena</span>
                                        </div>
                                        <ul>
                                            {% for plato in platos %}
                                                {% if plato.tipo == "cena" %}
                                                    <li class="plandiario-li">
                                                        <button type="button" class="food-item" onclick="abrirModalPlato('{{ plato.idplato }}', '{{ i }}', 'Cena')">
                                                            {{ plato.nombre }}
                                                        </button>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                        <!-- Comidas -->
                                        <div class="category category-comidas" onclick="toggleCategory(this)">
                                            <span class="toggle-arrow">▼</span>
                                            <span>Comidas</span>
                                        </div>
                                        <ul>
                                            {% for comida in comidas %}
                                                <li class="plandiario-li">
                                                    <button type="button" class="food-item comida-item" onclick="seleccionarComidaDirecta('{{ comida.nombre }}', '{{ i }}', '{{ comida.id }}')">
                                                        {{ comida.nombre }}
                                                    </button>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!-- Tabla de comidas -->
                            <div class="table-container">
                                <h2>Plan diario</h2>
                                <table id="tablaComidas{{ i }}" class="bloqueado"></table>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>COMIDA</th>
                                            <th>OPCIÓN 1</th>
                                            <th>OPCIÓN 2</th>
                                            <th>OPCIÓN 3</th>
                                            <th>DETALLES</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tipo in comidas_lista %}
                                            {% with tipo_lower=tipo|lower %}
                                                <tr>
                                                    <td class="meal-plan">{{ tipo }}</td>
                                                    <!-- Opción 1 -->
                                                    <td>
                                                        <button type="button" id="btn{{ tipo }}{{ i }}_1" class="btn btn-success btn-sm" onclick="openPlateModal('{{ i }}', '{{ tipo }}', '1')">+</button>
                                                        <div id="plato{{ tipo }}{{ i }}_1" class="selected-comida">
                                                            {% for plan in planes_dia %}
                                                                {% if plan.dia == i and plan.tipo_comida == tipo|upper %}
                                                                    {% for plato in plan.plato1 %}
                                                                        <button type="button" class="selected-comida">
                                                                            {{ plato.nombre }}
                                                                            <span class="remove-plato" onclick="removePlato(this, '{{ i }}', '{{ tipo_lower }}', '1')">×</span>
                                                                            <input type="hidden" name="plato1_dia{{ i }}_{{ tipo_lower }}" value="{{ plato.idplato }}">
                                                                        </button>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </td>
                                                    <!-- Opción 2 -->
                                                    <td>
                                                        <button type="button" id="btn{{ tipo }}{{ i }}_2" class="btn btn-success btn-sm" onclick="openPlateModal('{{ i }}', '{{ tipo }}', '2')">+ Opción</button>
                                                        <div id="plato{{ tipo }}{{ i }}_2" class="selected-comida">
                                                            {% for plan in planes_dia %}
                                                                {% if plan.dia == i and plan.tipo_comida == tipo|upper %}
                                                                    {% for plato in plan.plato2 %}
                                                                        <button type="button" class="selected-comida">
                                                                            {{ plato.nombre }}
                                                                            <span class="remove-plato" onclick="removePlato(this, '{{ i }}', '{{ tipo_lower }}', '2')">×</span>
                                                                            <input type="hidden" name="plato2_dia{{ i }}_{{ tipo_lower }}" value="{{ plato.idplato }}">
                                                                        </button>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </td>
                                                    <!-- Opción 3 -->
                                                    <td>
                                                        <button type="button" id="btn{{ tipo }}{{ i }}_3" class="btn btn-success btn-sm" onclick="openPlateModal('{{ i }}', '{{ tipo }}', '3')">+ Opción</button>
                                                        <div id="plato{{ tipo }}{{ i }}_3" class="selected-comida">
                                                            {% for plan in planes_dia %}
                                                                {% if plan.dia == i and plan.tipo_comida == tipo|upper %}
                                                                    {% for plato in plan.plato3 %}
                                                                        <button type="button" class="selected-comida">
                                                                            {{ plato.nombre }}
                                                                            <span class="remove-plato" onclick="removePlato(this, '{{ i }}', '{{ tipo_lower }}', '3')">×</span>
                                                                            <input type="hidden" name="plato3_dia{{ i }}_{{ tipo_lower }}" value="{{ plato.idplato }}">
                                                                        </button>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </td>
                                                    <!-- Detalles -->
                                                    <td>
                                                        <div id="detalles{{ tipo }}{{ i }}" class="detalles-comida"></div>
                                                        {% for plan in planes_dia %}
                                                            {% if plan.dia == i and plan.tipo_comida == tipo|upper %}
                                                                {% with descripcion=plan.descripcion|default:"" %}
                                                                    <textarea class="form-control" name="descripcion_dia{{ i }}_{{ tipo|lower }}" rows="1" placeholder="Descripción para {{ tipo|lower }}">{{ descripcion }}</textarea>
                                                                {% endwith %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                </tr>
                                            {% endwith %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <div class="button-group">
                                    <button type="submit" class="btn btn-success mt-3">Guardar Cambios</button>
                                    <a href="{% url 'pacientes:listapaciente' %}" class="btn btn-danger mt-3">Cancelar</a>
                                </div>
                            </div>
                            <div class="selected-comidas" id="selectedComidas{{ i }}"></div>
                        </div>
                    </section>
                {% endfor %}
            </div>
        </div>
    </form>
    <!-- Modales -->
    <div class="modal fade" id="plateModal" tabindex="-1" role="dialog" aria-labelledby="plateModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="plateModalLabel">Seleccione el plato a cargar</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Seleccione el plato a cargar</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para mostrar comidas de un plato -->
    <div class="modal fade" id="modalComidasPlato" tabindex="-1" role="dialog" aria-labelledby="modalComidasPlatoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalComidasPlatoLabel">Comidas del Plato</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="listaComidasPlato">
                        <!-- Aquí se cargarán las comidas dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary hidden" id="guardarModalBtn" onclick="guardarPlatoDesdeModal()">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos (sin cambios) */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    
    :root {
        --primary-color: #2A9D8F;
        --primary-light: #4FBDAF;
        --primary-dark: #1E7268;
        --accent-color: #E9C46A;
        --text-primary: #264653;
        --text-secondary: #607B83;
        --bg-light: #F8F9FA;
        --bg-white: #FFFFFF;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 20px;
    }
    
    body {
        font-family: 'Inter', 'Poppins', sans-serif;
        background-color: var(--bg-light);
        color: var(--text-primary);
        line-height: 1.6;
    }
    
    .section-title {
        text-align: left;
        padding: 32px 24px;
        margin-bottom: 24px;
        position: relative;
        border-radius: var(--radius-lg);
        background: linear-gradient(120deg, var(--primary-color), var(--primary-dark));
    }
    
    .section-title h2 {
        color: white;
        font-weight: 800;
        font-size: 3.5rem;
        line-height: 1.1;
        text-transform: uppercase;
        margin: 0;
        letter-spacing: 1px;
        position: relative;
        z-index: 2;
    }
    
    .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 120px;
        height: 120px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.15)' stroke-width='2'%3E%3Cpath d='M2.27 21.7s9.87-3.5 12.73-6.36a4.5 4.5 0 0 0 0-6.36 4.5 4.5 0 0 0-6.36 0c-2.86 2.86-6.36 12.73-6.36 12.73z'%3E%3C/path%3E%3Cpath d='M15.42 12.28 21.7 6'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        opacity: 0.8;
        z-index: 1;
    }
    
    .tabset > label {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 14px 20px;
        margin-right: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 15px;
        color: var(--text-secondary);
        background: var(--bg-white);
        border: none;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .tabset > label::before {
        font-family: 'Material Symbols Rounded', sans-serif;
        content: 'calendar_month';
        margin-right: 8px;
        font-size: 18px;
    }
    
    .tabset > input:checked + label {
        background: var(--primary-light);
        color: white;
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }
    
    /* Ajuste para ocultar todas las pestañas por defecto */
    .tab-panel {
        display: none;
    }
    
    /* Mostrar solo la pestaña activa */
    .tab-panel.active {
        display: block;
    }
    
    .tab-panels {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 30px;
        margin-top: 15px;
        position: relative;
    }
    
    .tab-panels::before {
        content: '';
        position: absolute;
        top: -5px;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        border-radius: var(--radius-md) var(--radius-md) 0 0;
    }
    
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin: 20px 0;
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }
    
    th {
        background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 14px;
        letter-spacing: 0.5px;
        padding: 16px;
        border: none;
    }
    
    td {
        padding: 14px 16px;
        border: none;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        background-color: var(--bg-white);
        transition: background-color 0.2s;
    }
    
    tr:last-child td {
        border-bottom: none;
    }
    
    tr:hover td {
        background-color: rgba(42, 157, 143, 0.05);
    }
    
    .meal-plan {
        font-weight: 600;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
    }
    
    /* .meal-plan::before {
        font-family: 'Material Symbols Rounded', sans-serif;
        margin-right: 8px;
        font-size: 20px;
    }
    
    td.meal-plan:nth-of-type(1)::before { content: 'breakfast_dining'; }
    td.meal-plan:nth-of-type(2)::before { content: 'lunch_dining'; }
    td.meal-plan:nth-of-type(3)::before { content: 'dinner_dining'; }
    td.meal-plan:nth-of-type(4)::before { content: 'restaurant'; } */
    
    .sidebar {
        background: var(--text-primary);
        color: white;
        padding: 20px;
        width: 200px;
        flex-shrink: 0;
        border-radius: var(--radius-lg);
        margin-right: 24px;
        min-height: 500px;
        position: relative;
        overflow: hidden;
    }
    
    .sidebar::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2'%3E%3Cpath d='M12 2a8 8 0 0 0-8 8c0 5 8 12 8 12s8-7 8-12a8 8 0 0 0-8-8zm0 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6z'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        opacity: 0.5;
    }
    
    .search-box {
        width: 100%;
        padding: 12px 16px;
        margin-bottom: 16px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(255,255,255,0.1);
        outline: none;
        font-size: 14px;
        background-color: rgba(255,255,255,0.1);
        color: white;
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
    }
    
    .search-box::placeholder {
        color: rgba(255,255,255,0.6);
    }
    
    .search-box:focus {
        background-color: rgba(255,255,255,0.15);
        border-color: rgba(255,255,255,0.3);
        box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
    }
    
    .category {
        font-weight: 600;
        margin: 14px 0 10px;
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        background: rgba(255,255,255,0.1);
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    
    .toggle-arrow {
        margin-right: 8px;
        transition: transform 0.3s ease;
    }
    
    .category.collapsed .toggle-arrow {
        transform: rotate(-90deg);
    }
    
    .food-item {
        width: 100%;
        background: none;
        border: none;
        color: rgba(255,255,255,0.8);
        text-align: left;
        font-size: 14px;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 2px;
    }
    
    .food-item:hover {
        background-color: rgba(255,255,255,0.1);
        color: white;
        transform: translateX(3px);
    }
    
    .btn {
        border-radius: var(--radius-md);
        font-weight: 600;
        padding: 10px 18px;
        transition: all 0.3s ease;
        border: none;
        letter-spacing: 0.3px;
        font-size: 14px;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-success {
        background-color: var(--primary-color);
        color: white;
    }
    
    .btn-success:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-danger {
        background-color: #E76F51;
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #c35a41;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: var(--radius-sm);
    }
    
    .button-group {
        display: flex;
        gap: 12px;
        margin-top: 30px;
        justify-content: flex-end;
    }
    
    /* Ajuste para mostrar múltiples platos en una celda */
    .selected-comida {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .selected-comida button {
        background-color: rgba(233, 196, 106, 0.2);
        border: 1px solid var(--accent-color);
        color: var(--text-primary);
        padding: 8px 30px 8px 12px;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
        margin: 4px 0;
        font-size: 14px;
        position: relative;
        transition: all 0.2s ease;
    }
    
    .selected-comida button:hover {
        background-color: rgba(233, 196, 106, 0.3);
    }
    
    .remove-plato {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(231, 111, 81, 0.1);
        color: #E76F51;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .remove-plato:hover {
        background: rgba(231, 111, 81, 0.2);
        transform: translateY(-50%) scale(1.1);
    }
    
    .modal-content {
        border: none;
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
        background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        padding: 16px 24px;
    }
    
    .modal-title {
        font-weight: 600;
        font-size: 18px;
    }
    
    .modal-body {
        padding: 24px;
    }
    
    .modal-footer {
        border-top: 1px solid rgba(0,0,0,0.05);
        padding: 16px 24px;
    }
    
    .comida-container {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px;
        border-radius: var(--radius-md);
        transition: all 0.2s ease;
    }
    
    .comida-container:hover {
        background-color: rgba(42, 157, 143, 0.05);
    }
    
    .comida-imagen {
        width: 80px;
        height: 80px;
        border-radius: var(--radius-md);
        object-fit: cover;
        box-shadow: var(--shadow-sm);
    }
    
    .comida-info {
        flex: 1;
    }
    
    .comida-info strong {
        color: var(--text-primary);
        font-size: 16px;
    }
    
    .comida-info small {
        color: var(--text-secondary);
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(42, 157, 143, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(42, 157, 143, 0); }
        100% { box-shadow: 0 0 0 0 rgba(42, 157, 143, 0); }
    }
    
    .btn-success:focus {
        animation: pulse 1.5s infinite;
    }
    
    .form-control {
        border-radius: var(--radius-md);
        border-color: rgba(0,0,0,0.1);
        padding: 10px 14px;
        transition: all 0.2s ease;
    }
    
    .form-control:focus {
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.15);
    }
    
    textarea.form-control {
        min-height: 60px;
        resize: vertical;
    }
    
    .main-container {
        display: flex;
        flex-direction: row;
        background: var(--bg-white);
        padding: 30px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
        gap: 24px;
    }
    
    .nutrition-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        color: var(--text-secondary);
        font-size: 12px;
    }
    
    .nutrition-bar {
        height: 4px;
        width: 100%;
        background-color: #eee;
        border-radius: 2px;
        overflow: hidden;
    }
    
    .nutrition-fill {
        height: 100%;
        background: linear-gradient(to right, #4CAF50, #8BC34A);
        border-radius: 2px;
    }
    
    .category-comidas {
        background: rgba(255, 255, 255, 0.15) !important;
        border-left: 4px solid var(--accent-color);
    }
    
    .category-comidas .food-item {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .category-comidas .food-item:hover {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    .hidden { display: none; }
    
    /* ponlo después de los demás estilos de la tabla  */
    th, td {
        vertical-align: top;   /* contenido pegado al borde superior */
    }
    
    .table-container {
        flex-grow: 1;
    }

    .table-container table {
    min-width: 800px;
}

th:first-child,
td.meal-plan {
    width: 100px;
    white-space: nowrap;
}

/* Pantalla completa */
.container {
    width: 100%;
    max-width: none;
    padding: 0 40px;
}

/* Elimina íconos de la columna COMIDA */
.meal-plan::before {
    display: none !important;
}

/* Reduce ancho de columna COMIDA */
th:first-child,
td.meal-plan {
    width: 120px;
    white-space: nowrap;
}

/* Sidebar más angosto */
.sidebar {
    width: 180px;
}

/* Expande tabla al máximo espacio posible */
.main-container {
    display: flex;
    gap: 20px;
    width: 100%;
}

.table-container {
    flex-grow: 1;
    width: 100%;
}

    
    </style>

<script>
let platoSeleccionadoId = null;
let opcionSeleccionada = null;

document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .selected-comida {
            position: relative;
            padding-right: 25px !important;
            margin: 5px 0;
        }
        .remove-plato {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-weight: bold;
            color: red;
        }
    `;
    document.head.appendChild(style);

    const tabInputs = document.querySelectorAll('.tabset > input[type="radio"]');
    
    tabInputs.forEach(input => {
        input.addEventListener('change', function() {
            seleccionHabilitada = false;
            diaSeleccionado = null;
            comidaSeleccionada = null;
            opcionSeleccionada = null;
            
            // Ocultar todas las pestañas y remover la clase 'active'
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.style.display = 'none';
                panel.classList.remove('active');
            });
            
            // Mostrar solo la pestaña seleccionada
            const panelId = this.getAttribute('aria-controls');
            const targetPanel = document.getElementById(panelId);
            targetPanel.style.display = 'block';
            
            // Forzar animación (si aplica)
            void targetPanel.offsetWidth;
            
            targetPanel.classList.add('active');
            
            createRippleEffect(this.nextElementSibling, event);
        });
    });
    
    // Mostrar la primera pestaña al cargar la página
    if (tabInputs.length > 0) {
        const firstPanelId = tabInputs[0].getAttribute('aria-controls');
        const firstPanel = document.getElementById(firstPanelId);
        firstPanel.style.display = 'block';
        
        setTimeout(() => {
            firstPanel.classList.add('active');
        }, 50);
    }
    
    function createRippleEffect(element, e) {
        const ripple = document.createElement('span');
        ripple.classList.add('ripple');
        
        const rect = element.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e ? e.clientX - rect.left - size / 2 : rect.width / 2;
        const y = e ? e.clientY - rect.top - size / 2 : rect.height / 2;
        
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        
        element.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    }
    
    const rippleStyle = document.createElement('style');
    rippleStyle.textContent = `
        .tabset > label {
            position: relative;
            overflow: hidden;
        }
        .ripple {
            position: absolute;
            background-color: rgba(49, 113, 91, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-effect 0.6s ease-out;
            pointer-events: none;
        }
        @keyframes ripple-effect {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(rippleStyle);

    // Actualizar visibilidad de botones de opciones
    updateOptionButtons();
});

let seleccionHabilitada = false;
let diaSeleccionado = null;
let comidaSeleccionada = null;

function toggleCategory(categoryElement) {
    categoryElement.classList.toggle('collapsed');
    const arrowElement = categoryElement.querySelector('.toggle-arrow');
    arrowElement.innerHTML = categoryElement.classList.contains('collapsed') ? "▶" : "▼";
    const categoryItems = categoryElement.nextElementSibling;
    
    if (categoryItems && categoryItems.tagName === 'UL') {
        if (categoryItems.classList.contains('hidden')) {
            categoryItems.classList.remove('hidden');
            categoryItems.style.maxHeight = '0px';
            setTimeout(() => {
                categoryItems.style.transition = 'max-height 0.3s ease';
                categoryItems.style.maxHeight = categoryItems.scrollHeight + 'px';
            }, 10);
        } else {
            categoryItems.style.maxHeight = categoryItems.scrollHeight + 'px';
            setTimeout(() => {
                categoryItems.style.maxHeight = '0px';
                setTimeout(() => {
                    categoryItems.classList.add('hidden');
                    categoryItems.style.maxHeight = '';
                }, 300);
            }, 10);
        }
    }
}

function filterList() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    const items = document.querySelectorAll('.food-list li');
    if (searchTerm) {
        document.querySelectorAll('.category-items').forEach(list => {
            list.classList.add("hidden");
        });
    }
    let visibleCategories = new Set();
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            item.style.display = "";
            const categoryList = item.parentElement;
            visibleCategories.add(categoryList);
        } else {
            item.style.display = "none";
        }
    });
    visibleCategories.forEach(categoryList => {
        categoryList.classList.remove("hidden");
        const categoryHeader = categoryList.previousElementSibling;
        const arrow = categoryHeader.querySelector(".toggle-arrow");
        if (arrow) arrow.innerHTML = "▼";
    });
    if (!searchTerm) {
        document.querySelectorAll('.category-items').forEach(list => {
            list.classList.remove("hidden");
        });
        document.querySelectorAll('.toggle-arrow').forEach(arrow => {
            arrow.innerHTML = "▼";
        });
    }
}

function habilitarSeleccion(dia, comida, opcion) {
    seleccionHabilitada = true;
    diaSeleccionado = dia;
    comidaSeleccionada = comida;
    opcionSeleccionada = opcion;
    console.log(`Habilitado - Día: ${diaSeleccionado}, Comida: ${comidaSeleccionada}, Opción: ${opcionSeleccionada}`);
}

function seleccionarComida(nombre, dia, idPlato) {
    event.preventDefault();
    if (seleccionHabilitada && diaSeleccionado === dia) {
        let divId = `plato${comidaSeleccionada}${dia}_${opcionSeleccionada}`;
        let inputName = `plato${opcionSeleccionada}_dia${dia}_${comidaSeleccionada.toLowerCase()}`;
        let divPlato = document.getElementById(divId);

        if (divPlato) {
            // Crear el nuevo elemento del plato
            let platoElement = document.createElement("button");
            platoElement.setAttribute("type", "button");
            platoElement.classList.add("selected-comida");
            platoElement.innerText = nombre;

            let removeBtn = document.createElement("span");
            removeBtn.classList.add("remove-plato");
            removeBtn.innerHTML = "×";
            removeBtn.onclick = function (e) {
                e.stopPropagation();
                removePlato(this, dia, comidaSeleccionada.toLowerCase(), opcionSeleccionada);
            };
            platoElement.appendChild(removeBtn);

            // Añadir el plato a la celda sin limpiar los anteriores
            divPlato.appendChild(platoElement);

            // Añadir un campo oculto para el plato
            let inputHidden = document.createElement("input");
            inputHidden.type = "hidden";
            inputHidden.name = inputName;
            inputHidden.value = idPlato;
            divPlato.appendChild(inputHidden);

            updateOptionButtons();
            seleccionHabilitada = false;
            diaSeleccionado = null;
            comidaSeleccionada = null;
            opcionSeleccionada = null;
            $('#plateModal').modal('hide');
            $('#modalComidasPlato').modal('hide');
        }
    }
}

function openPlateModal(dia, comida, opcion) {
    habilitarSeleccion(dia, comida, opcion);
    console.log(`Abriendo modal "plateModal" para Día: ${dia}, Comida: ${comida}, Opción: ${opcion}`);
    $('#plateModal').modal('show');
    
    const guardarModalBtn = document.getElementById('guardarModalBtn');
    if (guardarModalBtn) {
        guardarModalBtn.classList.remove('hidden');
    }
}

function abrirModalPlato(idPlato, dia, comida) {
    console.log(`Abriendo modalComidasPlato para plato ID: ${idPlato}, Día: ${dia}, Comida: ${comida}`);
    document.getElementById('listaComidasPlato').innerHTML = 'Cargando...';
    platoSeleccionadoId = idPlato;

    // Usar la opción seleccionada globalmente (opcionSeleccionada), que se establece en openPlateModal
    if (dia && comida && opcionSeleccionada) {
        habilitarSeleccion(dia, comida, opcionSeleccionada);
    } else {
        // Si no hay opción seleccionada, usar Opción 1 por defecto
        habilitarSeleccion(dia, comida, '1');
    }

    $('#modalComidasPlato').modal('show');

    fetch(`/comida/obtener_comidas_plato/${idPlato}/`)
        .then(response => {
            if (!response.ok) throw new Error('Error en la solicitud');
            return response.json();
        })
        .then(data => {
            if (data.comidas && data.comidas.length > 0) {
                let html = '<ul class="list-group">';
                data.comidas.forEach(comida => {
                    html += `
                        <li class="list-group-item" data-id="${comida.id}">
                            <div class="comida-container">
                                <img src="${comida.imagen}" alt="${comida.nombre}" class="comida-imagen">
                                <div class="comida-info">
                                    <strong>${comida.nombre}</strong><br>
                                    <small>Calorías: ${comida.calorias} kcal</small><br>
                                </div>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                document.getElementById('listaComidasPlato').innerHTML = html;
            } else {
                document.getElementById('listaComidasPlato').innerHTML = 'No hay comidas asociadas a este plato.';
            }
        })
        .catch(error => {
            console.error('Error al obtener las comidas:', error);
            document.getElementById('listaComidasPlato').innerHTML = 'Error al cargar las comidas.';
        });
}

function guardarPlatoDesdeModal() {
    if (seleccionHabilitada && diaSeleccionado && comidaSeleccionada && opcionSeleccionada && platoSeleccionadoId) {
        const platoButton = document.querySelector(`button[onclick*="abrirModalPlato('${platoSeleccionadoId}'"]`);
        const nombrePlato = platoButton ? platoButton.textContent.trim() : "Plato desconocido";
        seleccionarComida(nombrePlato, diaSeleccionado, platoSeleccionadoId);
        
        const guardarModalBtn = document.getElementById('guardarModalBtn');
        if (guardarModalBtn) {
            guardarModalBtn.classList.add('hidden');
        }
    } else {
        console.warn("No se puede guardar el plato: faltan datos de selección");
        alert("Por favor, seleccione un día, comida y opción para poder guardar.");
    }
}

function removePlato(element, dia, tipo, opcion) {
    // Eliminar el plato y su input asociado
    const platoElement = element.parentElement;
    const inputElement = platoElement.nextElementSibling;
    if (inputElement && inputElement.tagName === 'INPUT') {
        inputElement.remove();
    }
    platoElement.remove();
    updateOptionButtons();
}

function updateOptionButtons() {
    document.querySelectorAll('.tab-panel').forEach(panel => {
        const dia = panel.id.replace('dia', '');
        ['Desayuno', 'Almuerzo', 'Merienda', 'Cena'].forEach(tipo => {
            const divPlato1 = document.getElementById(`plato${tipo}${dia}_1`);
            const divPlato2 = document.getElementById(`plato${tipo}${dia}_2`);
            const divPlato3 = document.getElementById(`plato${tipo}${dia}_3`);
            const btnOpcion2 = document.getElementById(`btn${tipo}${dia}_2`);
            const btnOpcion3 = document.getElementById(`btn${tipo}${dia}_3`);

            // Ajustar la lógica para múltiples platos: el botón de Opción 2 aparece si hay al menos un plato en Opción 1
            const plato1Count = divPlato1.querySelectorAll('button.selected-comida').length;
            if (plato1Count > 0) {
                btnOpcion2.classList.remove('hidden');
            } else {
                btnOpcion2.classList.add('hidden');
                divPlato2.innerHTML = '';
            }

            // El botón de Opción 3 aparece si hay al menos un plato en Opción 2
            const plato2Count = divPlato2.querySelectorAll('button.selected-comida').length;
            if (plato2Count > 0) {
                btnOpcion3.classList.remove('hidden');
            } else {
                btnOpcion3.classList.add('hidden');
                divPlato3.innerHTML = '';
            }
        });
    });
}

function seleccionarComidaDirecta(nombre, dia, comidaId) {
    const tiposComida = ["Desayuno", "Almuerzo", "Merienda", "Cena"];
    let tipoSeleccionado = prompt("¿A qué tipo de comida desea asignar '" + nombre + "'? (Desayuno, Almuerzo, Merienda, Cena)", comidaSeleccionada || "Desayuno");

    if (!tipoSeleccionado || !tiposComida.includes(tipoSeleccionado)) {
        alert("Por favor, seleccione un tipo de comida válido.");
        return;
    }

    let divId = `plato${tipoSeleccionado}${dia}_1`;
    let inputName = `plato1_dia${dia}_${tipoSeleccionado.toLowerCase()}`;
    let divPlato = document.getElementById(divId);

    if (divPlato) {
        let comidaElement = document.createElement("button");
        comidaElement.setAttribute("type", "button");
        comidaElement.classList.add("selected-comida");
        comidaElement.innerText = nombre;

        let removeBtn = document.createElement("span");
        removeBtn.classList.add("remove-plato");
        removeBtn.innerHTML = "×";
        removeBtn.onclick = function (e) {
            e.stopPropagation();
            removePlato(this, dia, tipoSeleccionado.toLowerCase(), '1');
        };
        comidaElement.appendChild(removeBtn);

        // Añadir el plato a la celda sin limpiar los anteriores
        divPlato.appendChild(comidaElement);

        let inputHidden = document.createElement("input");
        inputHidden.type = "hidden";
        inputHidden.name = inputName;
        inputHidden.value = comidaId;
        divPlato.appendChild(inputHidden);

        updateOptionButtons();
        comidaSeleccionada = tipoSeleccionado;
    }
}

// Añadir fuentes web al head del documento
document.addEventListener('DOMContentLoaded', function() {
    const fontLink = document.createElement('link');
    fontLink.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap';
    fontLink.rel = 'stylesheet';
    document.head.appendChild(fontLink);
    
    const iconLink = document.createElement('link');
    iconLink.href = 'https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200';
    iconLink.rel = 'stylesheet';
    document.head.appendChild(iconLink);
    
    const foodItems = document.querySelectorAll('.food-item');
    foodItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(10px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.3s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, 100 + (index * 30));
    });
    
    const categories = document.querySelectorAll('.category');
    categories.forEach((category, index) => {
        if (index > 0) {
            category.classList.add('collapsed');
            const nextElement = category.nextElementSibling;
            if (nextElement && nextElement.tagName === 'UL') {
                nextElement.classList.add('hidden');
            }
        }
    });
});
</script>

{% endblock %}