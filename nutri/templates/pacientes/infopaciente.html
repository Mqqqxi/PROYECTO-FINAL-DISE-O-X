{% extends 'base.html' %}
{% load static %}

{% block title %}Información del Paciente{% endblock %}

{% block content %}
<style>
  /* Estilos modernos para 2025 - Aplicación de nutricionista */
  :root {
    --primary-color: #4ECDC4;
    --secondary-color: #35B5AA;
    --accent-color: #FF6B6B;
    --accent-secondary: #F8CB2E;
    --success-color: #7ABD7E;
    --warning-color: #FFD166;
    --danger-color: #EF476F;
    --background-light: #F5F7FA;
    --card-bg: #FFFFFF;
    --gray-light: #EFF1F3;
    --gray-medium: #D8DEE3;
    --text-primary: #212B36;
    --text-secondary: #637381;
    --card-shadow: 0 8px 24px rgba(149, 157, 165, 0.15);
    --hover-shadow: 0 12px 32px rgba(149, 157, 165, 0.25);
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
    --border-radius: 12px;
    --border-radius-sm: 8px;
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --gradient-bg: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  }

  body {
    font-family: 'Inter', 'Montserrat', sans-serif;
    background-color: var(--background-light);
    color: var(--text-primary);
    line-height: 1.7;
    margin: 0;
    padding: 0;
  }

  /* Contenedor principal */
  .container2 {
    max-width: 1280px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Header del paciente */
  .patient-profile-header {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    background: linear-gradient(135deg, var(--card-bg), var(--gray-light));
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    padding: 35px;
    margin-bottom: 35px;
    transition: var(--transition);
  }

  .patient-profile-header:hover {
    box-shadow: var(--hover-shadow);
    transform: translateY(-4px);
  }

  .patient-info {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .patient-avatar {
    width: 70px;
    height: 70px;
    border-radius: 18px;
    background: var(--gradient-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
  }

  .patient-details h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
  }

  .patient-details p {
    margin: 4px 0 0;
    color: var(--text-secondary);
    font-size: 14px;
  }

  .patient-stats {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .weight-info {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .weight-box {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 16px;
    text-align: center;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
  }

  .weight-box:hover {
    transform: translateY(-5px);
    box-shadow: var(--hover-shadow);
  }

  .weight-box h4 {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
    color: var(--primary-color);
  }

  .weight-box p {
    margin: 4px 0 0;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .appointment-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .appointment-box {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 16px;
    text-align: center;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
  }

  .appointment-box:hover {
    transform: translateY(-5px);
    box-shadow: var(--hover-shadow);
  }

  .appointment-box .date {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 0;
  }

  .appointment-box .time {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 2px 0 0;
  }

  .appointment-box p {
    margin: 4px 0 0;
    font-size: 12px;
    font-weight: 500;
  }

  /* Navegación principal */
  .main-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 30px;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--card-shadow);
    background-color: var(--card-bg);
  }

  .main-tab {
    flex: 1;
    padding: 18px 15px;
    text-align: center;
    font-weight: 500;
    font-size: 15px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
  }

  .main-tab.active {
    color: white;
    font-weight: 600;
    background: var(--gradient-bg);
  }

  .main-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    width: 100%;
    background: var(--gradient-bg);
  }

  .main-tab:hover {
    background: var(--secondary-color);
    color: white;
  }

  .main-tab i {
    font-size: 20px;
  }

  /* Sub-navegación */
  .clinical-tabs {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .clinical-tab {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    background: var(--card-bg);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow-sm);
  }

  .clinical-tab:hover {
    background: var(--secondary-color);
    color: white;
  }

  .clinical-tab.active {
    background: var(--primary-color);
    color: white;
    box-shadow: var(--card-shadow);
  }

  .clinical-tab-icon {
    font-size: 16px;
  }

  .spacer {
    flex-grow: 1;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .action-buttons .btn {
    padding: 10px;
    border-radius: var(--border-radius);
    background: var(--primary-color);
    color: white;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
  }

  .action-buttons .btn:hover {
    background: var(--accent-color);
    transform: translateY(-2px);
  }

  /* Contenido */
  .tab-content {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .tab-content.visible {
    opacity: 1;
  }

  .content-section {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    padding: 30px;
    min-height: 300px;
    border: 1px solid rgba(235, 238, 241, 0.8);
    transition: var(--transition);
    animation: fadeIn 0.4s ease-out;
  }

  .content-section:hover {
    box-shadow: var(--hover-shadow);
  }

  .content-card h4 {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 16px;
  }

  .data-row {
    display: flex;
    margin-bottom: 16px;
    padding: 12px 0;
    border-bottom: 1px solid var(--gray-medium);
    transition: var(--transition);
  }

  .data-row:hover {
    background-color: var(--gray-light);
    padding: 8px;
    margin: -8px -8px 8px -8px;
    border-radius: var(--border-radius-sm);
  }

  .data-row:last-child {
    border-bottom: none;
  }

  .data-label {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
    flex: 1;
  }

  .data-value {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  flex: 2;
  word-wrap: break-word; /* Permite que las palabras largas se rompan */
  word-break: break-all; /* Fuerza el rompimiento de palabras largas */
  overflow-wrap: break-word; /* Estándar moderno para word-wrap */
}

  

  /* Gráfico de progreso */
  .progress-chart {
    height: 350px;
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--card-shadow);
    margin-bottom: 25px;
    transition: var(--transition);
  }

  .progress-chart:hover {
    box-shadow: var(--hover-shadow);
  }

  /* Indicadores de progreso */
  .progress-indicator {
    display: flex;
    justify-content: space-between;
    margin: 30px 0;
  }

  .progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
  }

  .progress-step::after {
    content: '';
    position: absolute;
    top: 25px;
    left: 50%;
    width: 100%;
    height: 3px;
    background-color: var(--gray-medium);
    z-index: 1;
  }

  .progress-step:last-child::after {
    display: none;
  }

  .progress-step.completed::after {
    background-color: var(--primary-color);
  }

  .step-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--card-bg);
    border: 3px solid var(--gray-medium);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    position: relative;
    z-index: 2;
    transition: var(--transition);
  }

  .progress-step.completed .step-icon {
    border-color: var(--primary-color);
    background-color: var(--primary-color);
    color: white;
  }

  .step-label {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
  }

  .progress-step.completed .step-label {
    color: var(--primary-color);
    font-weight: 500;
  }

  /* Chat */
  .chat-container {
    height: 400px;
    border-radius: var(--border-radius);
    display: flex;
    flex-direction: column;
    box-shadow: var(--card-shadow);
    border: 1px solid var(--gray-medium);
    background: var(--card-bg);
    overflow: hidden;
  }

  .chat-messages {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .message {
    padding: 12px 18px;
    border-radius: 20px;
    max-width: 75%;
    font-size: 14px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    line-height: 1.5;
  }

  .message.nutricionista {
    background: var(--gradient-bg);
    color: white;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  .message.paciente {
    background: var(--gray-light);
    color: var(--text-primary);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }

  .chat-input {
    display: flex;
    padding: 15px;
    border-top: 1px solid var(--gray-medium);
    background: var(--card-bg);
  }

  .chat-input input {
    flex: 1;
    padding: 15px;
    border: 1px solid var(--gray-medium);
    border-radius: 30px;
    margin-right: 10px;
    transition: var(--transition);
  }

  .chat-input input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
  }

  .chat-input button {
    padding: 0 25px;
    background: var(--gradient-bg);
    color: white;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
  }

  .chat-input button:hover {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
    transform: translateY(-2px);
  }

  /* Botones */
  button,
  .btn {
    padding: 12px 24px;
    background: var(--gradient-bg);
    color: white;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: var(--shadow-sm);
  }

  button:hover,
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--danger-color), #F27999);
  }

  .btn-danger:hover {
    box-shadow: 0 5px 15px rgba(239, 71, 111, 0.3);
  }

  .btn-success {
    background: linear-gradient(135deg, var(--success-color), #5A9E5A);
  }

  .btn-success:hover {
    box-shadow: 0 5px 15px rgba(122, 189, 126, 0.3);
  }

  .btn-warning {
    background: linear-gradient(135deg, var(--warning-color), #FFBA08);
    color: var(--text-primary);
  }

  .btn-warning:hover {
    box-shadow: 0 5px 15px rgba(255, 209, 102, 0.3);
  }

  /* Animaciones */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsividad */
  @media (max-width: 1024px) {
    .patient-profile-header {
      grid-template-columns: 1fr;
      gap: 25px;
    }

    .weight-info {
      grid-template-columns: 1fr 1fr;
    }

    .content-section {
      padding: 20px;
    }
  }

  @media (max-width: 768px) {

    .weight-info,
    .appointment-info {
      grid-template-columns: 1fr;
    }

    .main-tabs {
      flex-direction: column;
      flex-wrap: wrap;
    }

    .main-tab {
      flex-basis: 100%;
    }

    .clinical-tabs {
      flex-direction: column;
      align-items: stretch;
    }

    .clinical-tab {
      flex-basis: 50%;
      text-align: center;
      justify-content: center;
    }

    .action-buttons {
      margin-top: 15px;
      width: 100%;
      justify-content: center;
    }
  }


  /* Estilos para las opciones dentro de cada comida */
  .meal-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .meal-option {
    background: var(--gray-light);
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    transition: var(--transition);
  }

  .meal-option:hover {
    background: rgba(78, 205, 196, 0.1);
  }

  .meal-option strong {
    color: var(--primary-color);
    font-size: 13px;
    margin-bottom: 4px;
    display: block;
  }

  .meal-option ul {
    margin: 0;
    padding-left: 20px;
    list-style-type: disc;
  }

  .meal-option li {
    margin-bottom: 4px;
    font-size: 13px;
    color: var(--text-primary);
  }

  .meal-option p {
    margin: 0;
    font-size: 13px;
    color: var(--text-secondary);
    font-style: italic;
  }






  /* Estilos para la tabla del plan nutricional */
  .nutrition-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
  }

  .nutrition-table th,
  .nutrition-table td {
    padding: 12px 16px;
    text-align: left;
    vertical-align: top;
    border-bottom: 1px solid var(--gray-medium);
  }

  .nutrition-table th {
    background-color: var(--gray-light);
    font-weight: 600;
    color: var(--text-primary);
    text-transform: uppercase;
    font-size: 13px;
  }

  .nutrition-table td {
    background-color: var(--card-bg);
    color: var(--text-primary);
  }

  .nutrition-day {
    font-weight: 600;
    color: var(--text-primary);
  }

  .nutrition-meal ul {
    margin: 0;
    padding-left: 20px;
    list-style-type: disc;
  }

  .nutrition-meal li {
    margin-bottom: 8px;
    line-height: 1.5;
  }

  .nutrition-meal small {
    display: block;
    margin-top: 8px;
    color: var(--text-secondary);
    font-size: 12px;
    font-style: italic;
  }

  .nutrition-table tr:hover {
    background-color: var(--gray-light);
  }

  /* Estilos para las opciones dentro de cada comida */
.meal-options {
  display: flex;
  flex-direction: row; /* Options are displayed side by side */
  gap: 10px;
  width: 100%;
  flex-wrap: nowrap; /* Prevent wrapping to ensure all options stay in one row */
  justify-content: space-between;
}

.meal-option {
  background: var(--gray-light);
  padding: 8px 12px;
  border-radius: var(--border-radius-sm);
  transition: var(--transition);
  flex: 1; /* Make each option take equal space */
  min-width: 100px; /* Reduced min-width to fit better in the cell */
  max-width: 150px; /* Added max-width to prevent overly wide options */
  box-sizing: border-box;
}

.meal-option:hover {
  background: rgba(78, 205, 196, 0.1);
}

.meal-option strong {
  color: var(--primary-color);
  font-size: 13px;
  margin-bottom: 4px;
  display: block;
}

.meal-option ul {
  margin: 0;
  padding-left: 20px;
  list-style-type: disc;
}

.meal-option li {
  margin-bottom: 4px;
  font-size: 13px;
  color: var(--text-primary);
}

.meal-option p {
  margin: 0;
  font-size: 13px;
  color: var(--text-secondary);
  font-style: italic;
}

/* Ensure the table cell is wide enough */
.nutrition-meal {
  vertical-align: top;
  padding: 10px;
  min-width: 350px; /* Increased to ensure all options fit in one row */
}

/* Adjust table styling for better fit */
.nutrition-table {
  width: 100%;
  border-collapse: collapse;
}

/* Add horizontal scrolling to the table container */
.nutrition-table-container {
  overflow-x: auto; /* Enable horizontal scrolling if the table is too wide */
  margin-bottom: 20px;
}

.nutrition-table th,
.nutrition-table td {
  border: 1px solid var(--gray-light);
  padding: 8px;
  text-align: left;
}

.nutrition-day {
  font-weight: bold;
  text-align: center;
  min-width: 100px; /* Ensure the day column has enough space */
}

.evolucion-action-buttons {
  margin-left: auto;
  display: none;
  gap: 8px;
}

.clinical-tabs {
  align-items: center;
  flex-wrap: nowrap;
}

@media (max-width: 768px) {
  .evolucion-action-buttons {
    margin-top: 10px;
    justify-content: center;
    width: 100%;
  }
}






</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container2">
    
  <!-- Header del paciente -->

  {% if not paciente.planes_nutricionales.exists %}
  <div style="
    margin-top: 100px;
    background-color: #EF476F;
    color: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 25px;
    font-weight: 600;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
  ">
    <i class="fas fa-exclamation-triangle"></i>
    Este paciente no tiene un plan nutricional creado. Por favor, crea uno para comenzar.
  </div>
  {% else %}
  <div style="margin-top: 100px;"></div>
  {% endif %}

  <div class="patient-profile-header">

    <div class="patient-info">

      <div class="patient-avatar">
        <i class="fas fa-user"></i>
      </div>
      
      <div class="patient-details">
        <h3>{{ paciente.persona.first_name }} {{ paciente.persona.last_name }}</h3>
        <p>Edad: {{ paciente.historia_clinica.edad|default:"--" }} | Género: {{ paciente.persona.genero|default:"--" }}
          | Objetivo: {{ paciente.objetivo|default:"--" }}</p>
      </div>
    </div>

    <div class="patient-stats">
      <div class="weight-info">
        <div class="weight-box">
          <h4>{{ peso_actual|default:"--" }} kg</h4>
          <p>Peso Actual</p>
        </div>
        <div class="weight-box">
          <h4>{{ peso_inicial|default:"--" }} kg</h4>
          <p>Peso Inicial</p>
        </div>
        <div class="weight-box">
          <h4>{{ valores_antropometricos.peso_meta|default:"--" }} kg</h4>
          <p>Peso Meta</p>
        </div>
      </div>
      <div class="appointment-info">
        <div class="appointment-box">
          <p class="date">{{ proximo_turno.dia|default:"--" }}</p>
          <p class="time">{{ proximo_turno.hora|time:"H:i"|default:"--" }}</p>
          <p>Próximo Turno</p>
        </div>
       <div class="appointment-box">
          <p class="date">{{ ultima_visita|date:"d F Y"|default:"--" }}</p>
          <p class="time">--</p> <!-- No se muestra hora para última visita -->
          <p>Última Visita</p>
        </div>
      </div>
    </div>
  </div>

  

  <!-- Navegación principal -->
  <div class="main-tabs">
    <div class="main-tab active" data-tab="info">
      <i class="fas fa-info-circle"></i>
      <span>Información</span>
    </div>
    <div class="main-tab" data-tab="plan">
      <i class="fas fa-clipboard-list"></i>
      <span>Plan Actual</span>
    </div>
  </div>

  

  <!-- Contenedor de pestañas de información -->
  <div id="info-content" class="tab-content visible">
    <div class="clinical-tabs">
      <div class="clinical-tab active" data-tab="paciente">
        <i class="fas fa-user clinical-tab-icon"></i> Paciente
      </div>
      <div class="clinical-tab" data-tab="antropometrico">
        <i class="fas fa-weight clinical-tab-icon"></i> Antropométrico
      </div>
      <div class="clinical-tab" data-tab="analisis">
        <i class="fas fa-flask clinical-tab-icon"></i> Análisis
      </div>
      <div class="clinical-tab" data-tab="anamnesis">
        <i class="fas fa-clipboard-list clinical-tab-icon"></i> Anamnesis
      </div>
      <div class="clinical-tab" data-tab="historia">
        <i class="fas fa-file-medical clinical-tab-icon"></i> Historia
      </div>
      <div class="spacer"></div>
       <!-- Botones de acción solo para nutricionistas -->
    {% if is_nutricionista %}
    <div class="action-buttons">
      {% if not paciente.valores_antropometricos %}
      <a href="{% url 'pacientes:crear_datos_paciente' paciente.pk %}" class="btn btn-success">
        <i class="fa fa-plus"></i> 
      </a>
      {% else %}
      <a href="{% url 'pacientes:editar_paciente' paciente.pk %}" class="btn btn-warning">
        <i class="fa fa-pencil"></i>
      </a>
      {% endif %}
      {% if paciente.persona.is_active %}
      <a href="{% url 'pacientes:deshabilitar_paciente' paciente.pk %}" class="btn btn-danger">
        <i class="fa fa-ban"></i>
      </a>
      {% else %}
      <a href="{% url 'pacientes:habilitar_paciente' paciente.pk %}" class="btn btn-success">
        <i class="fa fa-check"></i>
      </a>
      {% endif %}
    </div>
    {% endif %}
  </div>
    

    <!-- Contenido de Paciente -->
    <div id="paciente-content" class="content-section">
      <div class="content-card">
        <h4>Información Personal</h4>
        <div class="data-row">
          <div class="data-label">Nombre completo</div>
          <div class="data-value">{{ paciente.persona.first_name }} {{ paciente.persona.last_name }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Email</div>
          <div class="data-value">{{ paciente.persona.email|default:"--" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Tipo de documento</div>
          <div class="data-value">{{ paciente.persona.tipoDocumento|default:"--" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Número de documento</div>
          <div class="data-value">{{ paciente.persona.numDocumento|default:"--" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Obra Social</div>
          <div class="data-value">{{ paciente.obraSocial|default:"No especificada" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Objetivo</div>
          <div class="data-value">{{ paciente.objetivo|default:"--" }}</div>
        </div>
      </div>
    </div>

    <!-- Contenido de Valor Antropométrico -->
    <div id="antropometrico-content" class="content-section" style="display: none;">
      <div class="content-card">
        <h4>Valores Antropométricos</h4>
        <div class="data-row">
          <div class="data-label">Masa Muscular</div>
          <div class="data-value">{{ valores_antropometricos.masaMuscular|default:"No registrado" }} %</div>
        </div>
        <div class="data-row">
          <div class="data-label">Masa Grasa</div>
          <div class="data-value">{{ valores_antropometricos.masaGrasa|default:"No registrado" }} %</div>
        </div>
        <div class="data-row">
          <div class="data-label">Circunferencia</div>
          <div class="data-value">{{ valores_antropometricos.circunferencia|default:"No registrado" }} cm</div>
        </div>
        <div class="data-row">
          <div class="data-label">IMC</div>
          <div class="data-value">{{ valores_antropometricos.IMC|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Peso inicial</div>
          <div class="data-value">{{ valores_antropometricos.peso|default:"No registrado" }} kg</div>
        </div>
        <div class="data-row">
          <div class="data-label">Peso meta</div>
          <div class="data-value">{{ valores_antropometricos.peso_meta|default:"No registrado" }} kg</div>
        </div>
        <div class="data-row">
          <div class="data-label">Altura</div>
          <div class="data-value">{{ valores_antropometricos.altura|default:"No registrado" }} m</div>
        </div>
      </div>
    </div>

    <!-- Contenido de Análisis de Lab -->
    <div id="analisis-content" class="content-section" style="display: none;">
      <div class="content-card">
        <h4>Análisis de Laboratorio</h4>
        <div class="data-row">
          <div class="data-label">Hepatograma</div>
          <div class="data-value">{{ analisis_lab.hepatograma|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Creatinina Sérica</div>
          <div class="data-value">{{ analisis_lab.creatininaSerica|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Uricemia</div>
          <div class="data-value">{{ analisis_lab.uricemia|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Colesterol Total</div>
          <div class="data-value">{{ analisis_lab.colesterolTotal|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Uremia</div>
          <div class="data-value">{{ analisis_lab.uremia|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">HDL</div>
          <div class="data-value">{{ analisis_lab.hdl|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">LDL</div>
          <div class="data-value">{{ analisis_lab.ldl|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Trigiceridos</div>
          <div class="data-value">{{ analisis_lab.trigiceridos|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Glucemia</div>
          <div class="data-value">{{ analisis_lab.glucemia|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">VitaminaB12</div>
          <div class="data-value">{{ analisis_lab.vitaminaB12|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Albumina</div>
          <div class="data-value">{{ analisis_lab.albumina|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Perritina</div>
          <div class="data-value">{{ analisis_lab.perritina|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">GlobulosRojos</div>
          <div class="data-value">{{ analisis_lab.globulosRojos|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Leucositos</div>
          <div class="data-value">{{ analisis_lab.leucositos|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Hematocrito</div>
          <div class="data-value">{{ analisis_lab.hematocrito|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">VitaminaD</div>
          <div class="data-value">{{ analisis_lab.vitaminaD|default:"No registrado" }}</div>
        </div>
      


      </div>
    </div>

    <!-- Contenido de Anamnesis -->
    <div id="anamnesis-content" class="content-section" style="display: none;">
      <div class="content-card">
        <h4>Anamnesis</h4>
        <div class="data-row">
          <div class="data-label">Hábitos</div>
          <div class="data-value">{{ anamnesis.habitos|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Preferencias</div>
          <div class="data-value">{{ anamnesis.preferencia|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Frecuencia de Consumo</div>
          <div class="data-value">{{ anamnesis.frecConsumo|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Registro de Comida</div>
          <div class="data-value">{{ anamnesis.registroComida|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Alimentación Actual</div>
          <div class="data-value">{{ anamnesis.alimActual|default:"No registrado" }}</div>
        </div>
      </div>
    </div>

    <!-- Contenido de Historia Clínica -->
    <div id="historia-content" class="content-section" style="display: none;">
      <div class="content-card">
        <h4>Historia Clínica</h4>
        <div class="data-row">
          <div class="data-label">Medicamentos</div>
          <div class="data-value">{{ historia_clinica.medicamento|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Suplementos</div>
          <div class="data-value">{{ historia_clinica.suplemento|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Alergias</div>
          <div class="data-value">{{ historia_clinica.alergia|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Intolerancias</div>
          <div class="data-value">{{ historia_clinica.intolerancia|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Antecedentes Familiares</div>
          <div class="data-value">{{ historia_clinica.anteFamiliar|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Antecedentes Patológicos</div>
          <div class="data-value">{{ historia_clinica.antePatologico|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Patología Actual</div>
          <div class="data-value">{{ historia_clinica.patologiaActual|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Horas Actividad Física</div>
          <div class="data-value">{{ historia_clinica.hsActiFisica|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Tipo de Actividad Física</div>
          <div class="data-value">{{ historia_clinica.tipoActiFisica|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Actividad Laboral</div>
          <div class="data-value">{{ historia_clinica.actiLaboral|default:"No registrado" }}</div>
        </div>
        <div class="data-row">
          <div class="data-label">Comentario</div>
          <div class="data-value">{{ historia_clinica.comentario|default:"No registrado" }}</div>
        </div>
      </div>
    </div>



  </div>



  <!-- Contenedor de pestañas de plan actual -->
  <div id="plan-content" class="tab-content" style="display: none;">
    <div class="clinical-tabs">
      <div class="clinical-tab active" data-tab="progreso">
        <i class="fas fa-chart-line clinical-tab-icon"></i> Progreso
      </div>
      <div class="clinical-tab" data-tab="plan-nutricional">
        <i class="fas fa-utensils clinical-tab-icon"></i> Plan Nutricional
      </div>
      <div class="clinical-tab" data-tab="evolucion">
        <i class="fas fa-file-medical clinical-tab-icon"></i> Evolución
      </div>
      <div class="spacer"></div>
      <div class="plan-action-buttons action-buttons" style="display: none;">
        {% if is_nutricionista %}
        {% if not paciente.planes_nutricionales.exists %}
        <button type="button" class="btn" data-toggle="modal" data-target="#crearPlanModal{{ paciente.pk }}">
          <i class="fa fa-plus"></i> Crear Plan
        </button>
        {% else %}
        {% with plan=paciente.planes_nutricionales.first %}
        <a href="{% url 'plannutricional:editar_plan_dia' plan.idPlanN %}" class="btn">
          <i class="fa fa-edit"></i> Editar
        </a>
        <!-- Botón para abrir el modal de eliminación -->
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#confirmarEliminarPlanModal" data-plan-id="{{ plan.idPlanN }}">
          <i class="fa fa-trash"></i> Eliminar
        </button>
        {% endwith %}
        {% endif %}
        {% endif %}
        {% if paciente.planes_nutricionales.exists %}
        <a href="#" class="btn" onclick="printPlanNutricional()">
          <i class="fa fa-print"></i> Imprimir
        </a>
        {% endif %}
      </div><div class="plan-action-buttons action-buttons" style="display: none;">
        {% if is_nutricionista %}
        {% if not paciente.planes_nutricionales.exists %}
        <button type="button" class="btn" data-toggle="modal" data-target="#crearPlanModal{{ paciente.pk }}">
          <i class="fa fa-plus"></i>
        </button>
        {% else %}
        {% with plan=paciente.planes_nutricionales.first %}
        <a href="{% url 'plannutricional:editar_plan_dia' plan.idPlanN %}" class="btn">
          <i class="fa fa-edit"></i> Editar
        </a>
        <!-- Botón para abrir el modal de eliminación -->
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#confirmarEliminarPlanModal" data-plan-id="{{ plan.idPlanN }}">
          <i class="fa fa-trash"></i> Eliminar
        </button>
        {% endwith %}
        {% endif %}
        {% endif %}
        {% if paciente.planes_nutricionales.exists %}
        <a href="#" class="btn" onclick="printPlanNutricional()">
          <i class="fa fa-print"></i> Imprimir
        </a>
        {% endif %}
      </div><div class="plan-action-buttons action-buttons" style="display: none;">
        {% if is_nutricionista %}
        {% if not paciente.planes_nutricionales.exists %}
        <button type="button" class="btn" data-toggle="modal" data-target="#crearPlanModal{{ paciente.pk }}">
          <i class="fa fa-plus"></i>
        </button>
        {% else %}
        {% with plan=paciente.planes_nutricionales.first %}
        <a href="{% url 'plannutricional:editar_plan_dia' plan.idPlanN %}" class="btn">
          <i class="fa fa-edit"></i> Editar
        </a>
        <!-- Botón para abrir el modal de eliminación -->
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#confirmarEliminarPlanModal" data-plan-id="{{ plan.idPlanN }}">
          <i class="fa fa-trash"></i> Eliminar
        </button>
        {% endwith %}
        {% endif %}
        {% endif %}
        {% if paciente.planes_nutricionales.exists %}
        <a href="#" class="btn" onclick="printPlanNutricional()">
          <i class="fa fa-print"></i> Imprimir
        </a>
        {% endif %}
      </div><div class="plan-action-buttons action-buttons" style="display: none;">
        {% if is_nutricionista %}
        {% if not paciente.planes_nutricionales.exists %}
        <button type="button" class="btn" data-toggle="modal" data-target="#crearPlanModal{{ paciente.pk }}">
          <i class="fa fa-plus"></i>
        </button>
        {% else %}
        {% with plan=paciente.planes_nutricionales.first %}
        <a href="{% url 'plannutricional:editar_plan_dia' plan.idPlanN %}" class="btn">
          <i class="fa fa-edit"></i> Editar
        </a>
        <!-- Botón para abrir el modal de eliminación -->
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#confirmarEliminarPlanModal" data-plan-id="{{ plan.idPlanN }}">
          <i class="fa fa-trash"></i> Eliminar
        </button>
        {% endwith %}
        {% endif %}
        {% endif %}
        {% if paciente.planes_nutricionales.exists %}
        <a href="#" class="btn" onclick="printPlanNutricional()">
          <i class="fa fa-print"></i> Imprimir
        </a>
        {% endif %}
      </div><div class="plan-action-buttons action-buttons" style="display: none;">
        {% if is_nutricionista %}
        {% if not paciente.planes_nutricionales.exists %}
        <button type="button" class="btn" data-toggle="modal" data-target="#crearPlanModal{{ paciente.pk }}">
          <i class="fa fa-plus"></i>
        </button>
        {% else %}
        {% with plan=paciente.planes_nutricionales.first %}
        <a href="{% url 'plannutricional:editar_plan_dia' plan.idPlanN %}" class="btn">
          <i class="fa fa-edit"></i> Editar
        </a>
        <!-- Botón para abrir el modal de eliminación -->
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#confirmarEliminarPlanModal" data-plan-id="{{ plan.idPlanN }}">
          <i class="fa fa-trash"></i> Eliminar
        </button>
        {% endwith %}
        {% endif %}
        {% endif %}
        {% if paciente.planes_nutricionales.exists %}
        <a href="#" class="btn" onclick="printPlanNutricional()">
          <i class="fa fa-print"></i> Imprimir
        </a>
        {% endif %}
      </div>
    </div>

    <!-- Modal para crear plan nutricional -->
    <div class="modal fade" id="crearPlanModal{{ paciente.pk }}" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <form method="POST" action="{% url 'plannutricional:crear_plan_nutricional_modal' paciente.pk %}">
          {% csrf_token %}
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Crear Plan Nutricional</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="fecha_inicio_{{ paciente.pk }}">Fecha Inicio</label>
                <input type="date" class="form-control" id="fecha_inicio_{{ paciente.pk }}" name="fecha_inicio"
                       min="2000-01-01" max="2200-12-31" required>
            </div>
              <div class="form-group">
                <label for="duracion_dias_{{ paciente.pk }}">Duración (días)</label>
                <input type="number" class="form-control" id="duracion_dias_{{ paciente.pk }}" name="duracion_dias"
                  value="30" min="1" required>
              </div>
              <div class="form-group">
                <label for="recomendacion_{{ paciente.pk }}">Recomendación</label>
                <textarea class="form-control" id="recomendacion_{{ paciente.pk }}" name="recomendacion"
                  required></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn">Guardar</button>
              <button type="button" class="btn" style="background: #A0AEC0;" data-dismiss="modal">Cancelar</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para confirmar eliminación del plan nutricional -->
<div class="modal fade" id="confirmarEliminarPlanModal" tabindex="-1" role="dialog" aria-labelledby="confirmarEliminarPlanModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmarEliminarPlanModalLabel">Confirmar Eliminación</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que deseas eliminar este plan nutricional? Esta acción no se puede deshacer.
      </div>
      <div class="modal-footer">
        <form id="eliminarPlanForm" method="post" action="">
          {% csrf_token %}
          <button type="button" class="btn" style="background: #A0AEC0;" data-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

    <!-- Contenido de Progreso -->
    <div id="progreso-content" class="content-section">
      <div class="content-card">
        <h4>Evolución de Medidas</h4>
        <div class="data-row">
          <div class="data-label">Peso Inicial</div>
          <div class="data-value">{{ peso_inicial|default:"--" }} kg</div>
        </div>
        <div class="data-row">
          <div class="data-label">Peso Actual</div>
          <div class="data-value">{{ peso_actual|default:"--" }} kg</div>
        </div>
        <div class="data-row">
          <div class="data-label">Peso Meta</div>
          <div class="data-value">{{ peso_meta|default:"--" }} kg</div>
        </div>
        <div class="data-row">
          <div class="data-label">Diferencia</div>
          <div class="data-value">
            {% if diferencia_peso is not None %}
            {% if diferencia_peso > 0 %}
            <span style="color: var(--accent-color);">+{{ diferencia_peso }} kg</span>
            {% elif diferencia_peso < 0 %} <span style="color: var(--primary-color);">{{ diferencia_peso }} kg</span>
              {% else %}
              0 kg
              {% endif %}
              {% else %}
              --
              {% endif %}
          </div>
        </div>
        <div class="data-row">
          <div class="data-label">% Completado</div>
          <div class="data-value">{{ porcentaje_completado|default:"--" }}%</div>
        </div>
      </div>
    </div>

    <!-- Contenido de Plan Nutricional -->
    <div id="plan-nutricional-content" class="content-section" style="display: none;">
      <div class="content-card">
        <h4>Plan Nutricional</h4>
        <!-- Agregamos recomendación si existe -->
        {% if recomendacion %}
        <div id="recomendacion-impresion" class="mb-3">
          <strong>Recomendación nutricional:</strong>
          <p>{{ recomendacion }}</p>
        </div>
        {% endif %}
        {% if plan_data %}
        <!-- Tabla para mostrar los días y tipos de comida con opciones -->
        <div style="overflow-x: auto;">
          <table class="nutrition-table">
            <!-- Encabezados de las columnas -->
            <thead>
              <tr>
                <th>DÍA</th>
                <th>DESAYUNO</th>
                <th>ALMUERZO</th>
                <th>MERIENDA</th>
                <th>CENA</th>
              </tr>
            </thead>
            <tbody>
              <!-- Iterar sobre los datos del plan -->
              {% for dia_data in plan_data %}
              <tr>
                <!-- Día -->
                <td class="nutrition-day">{{ dia_data.dia_nombre }}</td>
                <!-- Desayuno -->
                <td class="nutrition-meal">
                  <div class="meal-options">
                    <div class="meal-option">
                      <strong>OP1:</strong>
                      {% if dia_data.desayuno.op1 %}
                      <ul>
                        {% for plato in dia_data.desayuno.op1 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                    <div class="meal-option">
                      <strong>OP2:</strong>
                      {% if dia_data.desayuno.op2 %}
                      <ul>
                        {% for plato in dia_data.desayuno.op2 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                    <div class="meal-option">
                      <strong>OP3:</strong>
                      {% if dia_data.desayuno.op3 %}
                      <ul>
                        {% for plato in dia_data.desayuno.op3 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                  </div>
                  {% if dia_data.desayuno.descripcion %}
                  <small>{{ dia_data.desayuno.descripcion }}</small>
                  {% endif %}
                </td>
                <!-- Almuerzo -->
                <td class="nutrition-meal">
                  <div class="meal-options">
                    <div class="meal-option">
                      <strong>OP1:</strong>
                      {% if dia_data.almuerzo.op1 %}
                      <ul>
                        {% for plato in dia_data.almuerzo.op1 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                    <div class="meal-option">
                      <strong>OP2:</strong>
                      {% if dia_data.almuerzo.op2 %}
                      <ul>
                        {% for plato in dia_data.almuerzo.op2 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                    <div class="meal-option">
                      <strong>OP3:</strong>
                      {% if dia_data.almuerzo.op3 %}
                      <ul>
                        {% for plato in dia_data.almuerzo.op3 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                  </div>
                  {% if dia_data.almuerzo.descripcion %}
                  <small>{{ dia_data.almuerzo.descripcion }}</small>
                  {% endif %}
                </td>
                <!-- Merienda -->
                <td class="nutrition-meal">
                  <div class="meal-options">
                    <div class="meal-option">
                      <strong>OP1:</strong>
                      {% if dia_data.merienda.op1 %}
                      <ul>
                        {% for plato in dia_data.merienda.op1 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                    <div class="meal-option">
                      <strong>OP2:</strong>
                      {% if dia_data.merienda.op2 %}
                      <ul>
                        {% for plato in dia_data.merienda.op2 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                    <div class="meal-option">
                      <strong>OP3:</strong>
                      {% if dia_data.merienda.op3 %}
                      <ul>
                        {% for plato in dia_data.merienda.op3 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                  </div>
                  {% if dia_data.merienda.descripcion %}
                  <small>{{ dia_data.merienda.descripcion }}</small>
                  {% endif %}
                </td>
                <!-- Cena -->
                <td class="nutrition-meal">
                  <div class="meal-options">
                    <div class="meal-option">
                      <strong>OP1:</strong>
                      {% if dia_data.cena.op1 %}
                      <ul>
                        {% for plato in dia_data.cena.op1 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                    <div class="meal-option">
                      <strong>OP2:</strong>
                      {% if dia_data.cena.op2 %}
                      <ul>
                        {% for plato in dia_data.cena.op2 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                    <div class="meal-option">
                      <strong>OP3:</strong>
                      {% if dia_data.cena.op3 %}
                      <ul>
                        {% for plato in dia_data.cena.op3 %}
                        <li>{{ plato }}</li>
                        {% endfor %}
                      </ul>
                      {% else %}
                      <p>-</p>
                      {% endif %}
                    </div>
                  </div>
                  {% if dia_data.cena.descripcion %}
                  <small>{{ dia_data.cena.descripcion }}</small>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p>No hay un plan nutricional activo para este paciente.</p>
        {% endif %}
      </div>
    </div>

   
    <div id="evolucion-content" class="content-section" style="display: none;">
      <div class="content-card">
        <h4>Evolución</h4>
    
        <!-- Selector de fechas para ver datos históricos -->
        <div class="form-group">
          <label for="fechaSelectEvolucion">Seleccionar Fecha</label>
          <select class="form-control selectpicker" id="fechaSelectEvolucion" onchange="cargarDatosEvolucion()">
            <option value="">Selecciona una fecha</option>
            {% for progreso in progresos %}
            <option value="{{ progreso.fecha|date:'Y-m-d' }}">{{ progreso.fecha|date:'d/m/Y' }}</option>
            {% endfor %}
          </select>
        </div>
    
        <!-- Contenedor para mostrar datos de evolución -->
        <div id="datosEvolucionContainer">
          <p>Selecciona una fecha para ver los datos.</p>
        </div>
    
        <!-- Formulario para actualizar datos -->
        {% if is_nutricionista %}
        <div class="card form-section mt-4">
          <h5><i class="fa fa-heartbeat" aria-hidden="true"></i> Actualizar Evolución</h5>
          <button class="btn-toggle" type="button" data-toggle="collapse" data-target="#formEvolucion" aria-expanded="false"
            aria-controls="formEvolucion">
            <i class="fa fa-chevron-down" aria-hidden="true"></i> Ingresar Nuevos Datos
          </button>
          <div id="formEvolucion" class="collapse collapse-section">
            <form method="POST" enctype="multipart/form-data" action="{% url 'progreso:crear_progreso' paciente.pk %}">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="evolucion">
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="peso" class="form-label">Peso (kg):</label>
                  <input type="text" class="form-control" id="peso" name="peso" placeholder="Peso" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="perimetro_pecho" class="form-label">Perímetro pecho (cm):</label>
                  <input type="text" class="form-control" id="perimetro_pecho" name="perimetro_pecho"
                    placeholder="Perímetro pecho" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="indice_grasa_corporal" class="form-label">Índice de grasa corporal (%):</label>
                  <input type="text" class="form-control" id="indice_grasa_corporal" name="indice_grasa_corporal"
                    placeholder="Índice de grasa" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="masa_muscular" class="form-label">Masa muscular (kg):</label>
                  <input type="text" class="form-control" id="masa_muscular" name="masa_muscular"
                    placeholder="Masa muscular" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="agua_corporal" class="form-label">Agua corporal (%):</label>
                  <input type="text" class="form-control" id="agua_corporal" name="agua_corporal"
                    placeholder="Agua corporal" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="perimetro_cintura" class="form-label">Perímetro cintura (cm):</label>
                  <input type="text" class="form-control" id="perimetro_cintura" name="perimetro_cintura"
                    placeholder="Perímetro cintura" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="perimetro_cadera" class="form-label">Perímetro cadera (cm):</label>
                  <input type="text" class="form-control" id="perimetro_cadera" name="perimetro_cadera"
                    placeholder="Perímetro cadera" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="perimetro_muslo" class="form-label">Perímetro muslo (cm):</label>
                  <input type="text" class="form-control" id="perimetro_muslo" name="perimetro_muslo"
                    placeholder="Perímetro muslo" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="perimetro_brazo" class="form-label">Perímetro brazo (cm):</label>
                  <input type="text" class="form-control" id="perimetro_brazo" name="perimetro_brazo"
                    placeholder="Perímetro brazo" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="tension_arterial_maxima" class="form-label">Tensión arterial máxima (mmHg):</label>
                  <input type="text" class="form-control" id="tension_arterial_maxima" name="tension_arterial_maxima"
                    placeholder="Tensión arterial máxima" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-4">
                  <label for="tension_arterial_minima" class="form-label">Tensión arterial mínima (mmHg):</label>
                  <input type="text" class="form-control" id="tension_arterial_minima" name="tension_arterial_minima"
                    placeholder="Tensión arterial mínima" required data-type="numeric" inputmode="decimal">
                </div>
                <div class="col-md-6">
                  <label for="comentario" class="form-label">Comentario:</label>
                  <textarea class="form-control" id="comentario" name="comentario" rows="3"
                    placeholder="Comentario opcional" required></textarea>
                </div>
                <div class="col-md-6">
                  <label for="fecha" class="form-label">Fecha:</label>
                  <input type="date" class="form-control" id="fecha" name="fecha" value="{{ today|date:'Y-m-d' }}"
                  min="1900-01-01" max="2100-12-31" required>>
                </div>
              </div>
              <div class="row g-3 mt-3">
                <div class="col-md-12 text-center">
                  <button type="submit" class="btn btn-save">
                    <i class="fa fa-save" aria-hidden="true"></i> Guardar
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        {% endif %}
        <!-- Modal para editar datos de evolución -->
        {% if is_nutricionista %}
        <div class="modal fade" id="editarProgresoModal{{ paciente.pk }}" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <form method="POST" enctype="multipart/form-data" action="{% url 'progreso:editar_progreso' paciente.pk %}">
              {% csrf_token %}
              <input type="hidden" name="fecha" id="edit_fecha">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Editar Datos de Evolución</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="edit_peso" class="form-label">Peso (kg):</label>
                      <input type="text" class="form-control" id="edit_peso" name="peso" placeholder="Peso" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_perimetro_pecho" class="form-label">Perímetro pecho (cm):</label>
                      <input type="text" class="form-control" id="edit_perimetro_pecho" name="perimetro_pecho"
                        placeholder="Perímetro pecho" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_indice_grasa_corporal" class="form-label">Índice de grasa corporal (%):</label>
                      <input type="text" class="form-control" id="edit_indice_grasa_corporal" name="indice_grasa_corporal"
                        placeholder="Índice de grasa" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_masa_muscular" class="form-label">Masa muscular (kg):</label>
                      <input type="text" class="form-control" id="edit_masa_muscular" name="masa_muscular"
                        placeholder="Masa muscular" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_agua_corporal" class="form-label">Agua corporal (%):</label>
                      <input type="text" class="form-control" id="edit_agua_corporal" name="agua_corporal"
                        placeholder="Agua corporal" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_perimetro_cintura" class="form-label">Perímetro cintura (cm):</label>
                      <input type="text" class="form-control" id="edit_perimetro_cintura" name="perimetro_cintura"
                        placeholder="Perímetro cintura" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_perimetro_cadera" class="form-label">Perímetro cadera (cm):</label>
                      <input type="text" class="form-control" id="edit_perimetro_cadera" name="perimetro_cadera"
                        placeholder="Perímetro cadera" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_perimetro_muslo" class="form-label">Perímetro muslo (cm):</label>
                      <input type="text" class="form-control" id="edit_perimetro_muslo" name="perimetro_muslo"
                        placeholder="Perímetro muslo" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_perimetro_brazo" class="form-label">Perímetro brazo (cm):</label>
                      <input type="text" class="form-control" id="edit_perimetro_brazo" name="perimetro_brazo"
                        placeholder="Perímetro brazo" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_tension_arterial_maxima" class="form-label">Tensión arterial máxima (mmHg):</label>
                      <input type="text" class="form-control" id="edit_tension_arterial_maxima" name="tension_arterial_maxima"
                        placeholder="Tensión arterial máxima" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_tension_arterial_minima" class="form-label">Tensión arterial mínima (mmHg):</label>
                      <input type="text" class="form-control" id="edit_tension_arterial_minima" name="tension_arterial_minima"
                        placeholder="Tensión arterial mínima" required data-type="numeric" inputmode="decimal">
                    </div>
                    <div class="col-md-12">
                      <label for="edit_comentario" class="form-label">Comentario:</label>
                      <textarea class="form-control" id="edit_comentario" name="comentario" rows="3"
                        placeholder="Comentario opcional" required></textarea>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn">Guardar</button>
                  <button type="button" class="btn" style="background: #A0AEC0;" data-dismiss="modal">Cancelar</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  // Definir is_nutricionista desde el contexto de Django
  const isNutricionista = "{{ is_nutricionista|yesno:'true,false' }}" === "true";

  document.addEventListener('DOMContentLoaded', function () {
    // Navegación de pestañas principales
    const mainTabs = document.querySelectorAll('.main-tab');
    mainTabs.forEach(tab => {
      tab.addEventListener('click', function () {
        mainTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
          content.classList.remove('visible');
        });
        const tabId = this.getAttribute('data-tab');
        const selectedContent = document.getElementById(`${tabId}-content`);
        selectedContent.style.display = 'block';
        setTimeout(() => selectedContent.classList.add('visible'), 10);
        const activeSubTab = document.querySelector(`#${tabId}-content .clinical-tab.active`);
        if (activeSubTab) activeSubTab.click();
      });
    });

    // Navegación de subpestañas
    const subTabs = document.querySelectorAll('.clinical-tab');
    subTabs.forEach(tab => {
      tab.addEventListener('click', function () {
        const siblings = Array.from(this.parentElement.children);
        siblings.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const tabId = this.getAttribute('data-tab');
        const parentId = this.closest('.tab-content').id.split('-')[0];
        document.querySelectorAll(`#${parentId}-content .content-section`).forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById(`${tabId}-content`).style.display = 'block';

        // Mostrar u ocultar botones de acción en plan-content
        if (parentId === 'plan') {
          const planActionButtons = document.querySelector('#plan-content .plan-action-buttons');
          const evolucionActionButtons = document.querySelector('#plan-content .evolucion-action-buttons');
          
          // Mostrar plan-action-buttons solo en la pestaña plan-nutricional
          if (planActionButtons) {
            planActionButtons.style.display = tabId === 'plan-nutricional' ? 'flex' : 'none';
          }
          
          // Mostrar evolucion-action-buttons solo en la pestaña evolucion y si es nutricionista
          if (evolucionActionButtons && isNutricionista) {
            evolucionActionButtons.style.display = tabId === 'evolucion' ? 'flex' : 'none';
          } else if (evolucionActionButtons) {
            evolucionActionButtons.style.display = 'none';
          }
        }
      });
    });

    // Activar pestaña Evolución si se indica en la URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tab') === 'evolucion') {
      const planTab = document.querySelector('.main-tab[data-tab="plan"]');
      const evolucionSubTab = document.querySelector('.clinical-tab[data-tab="evolucion"]');
      if (planTab && evolucionSubTab) {
        planTab.click();
        evolucionSubTab.click();
      }
    } else if (urlParams.get('tab') === 'plan-nutricional') {
      const planTab = document.querySelector('.main-tab[data-tab="plan"]');
      const planNutricionalSubTab = document.querySelector('.clinical-tab[data-tab="plan-nutricional"]');
      if (planTab && planNutricionalSubTab) {
        planTab.click();
        planNutricionalSubTab.click();
      }
    }
  });

  function cargarDatosEvolucion() {
    const fecha = $('#fechaSelectEvolucion').val();
    const datosContainer = $('#datosEvolucionContainer');

    if (fecha) {
      console.log(`Cargando datos para fecha: ${fecha}`);
      $.ajax({
        url: `/progreso/obtener_datos_progreso/{{ paciente.pk }}/${fecha}/`,
        method: 'GET',
        success: function (data) {
          console.log('Datos recibidos:', data);
          if (data.error) {
            datosContainer.html('<p>' + data.error + '</p>');
            return;
          }
          let html = `
            <div class="data-row">
              <div class="data-label">Peso</div>
              <div class="data-value">${data.peso || '-'} kg</div>
            </div>
            <div class="data-row">
              <div class="data-label">Índice de grasa corporal</div>
              <div class="data-value">${data.indice_grasa_corporal || '-'} %</div>
            </div>
            <div class="data-row">
              <div class="data-label">Perímetro cintura</div>
              <div class="data-value">${data.perimetro_cintura || '-'} cm</div>
            </div>
            <div class="data-row">
              <div class="data-label">Perímetro cadera</div>
              <div class="data-value">${data.perimetro_cadera || '-'} cm</div>
            </div>
            <div class="data-row">
              <div class="data-label">Perímetro muslo</div>
              <div class="data-value">${data.perimetro_muslo || '-'} cm</div>
            </div>
            <div class="data-row">
              <div class="data-label">Perímetro brazo</div>
              <div class="data-value">${data.perimetro_brazo || '-'} cm</div>
            </div>
            <div class="data-row">
              <div class="data-label">Perímetro pecho</div>
              <div class="data-value">${data.perimetro_pecho || '-'} cm</div>
            </div>
            <div class="data-row">
              <div class="data-label">Masa muscular</div>
              <div class="data-value">${data.masa_muscular || '-'} kg</div>
            </div>
            <div class="data-row">
              <div class="data-label">Agua corporal</div>
              <div class="data-value">${data.agua_corporal || '-'} %</div>
            </div>
            <div class="data-row">
              <div class="data-label">Tensión arterial</div>
              <div class="data-value">${data.tension_arterial_maxima || '-'} / ${data.tension_arterial_minima || '-'} mmHg</div>
            </div>
            <div class="data-row">
              <div class="data-label">Comentario</div>
              <div class="data-value">${data.comentario || '-'}</div>
            </div>
          `;
          // Agregar el botón "Editar" solo si el usuario es nutricionista
          if (isNutricionista) {
            html += `
              <div class="action-buttons" style="margin-top: 20px;">
                <button type="button" class="btn edit-progress-btn" data-toggle="modal" data-target="#editarProgresoModal{{ paciente.pk }}" data-fecha="${fecha}" data-progreso='${JSON.stringify(data)}'>
                  <i class="fa fa-edit"></i> Editar
                </button>
              </div>
            `;
          }
          if (data.fotos && data.fotos.length > 0) {
            html += '<h5>Fotos:</h5><div class="photo-upload">';
            data.fotos.forEach(foto => {
              html += `
                <div>
                  <label>${foto.descripcion}</label>
                  <div class="image-preview">
                    <img src="${foto.url}" alt="${foto.descripcion}">
                  </div>
                </div>
              `;
            });
            html += '</div>';
          }
          datosContainer.html(html);

          // Asignar evento de clic a los botones de edición (si existen)
          if (isNutricionista) {
            $('.edit-progress-btn').on('click', function () {
              const fecha = $(this).data('fecha');
              const progresoData = $(this).data('progreso');
              prellenarFormularioEdicion(fecha, progresoData);
            });
          }
        },
        error: function (xhr, status, error) {
          console.error('Error AJAX:', xhr.status, error, xhr.responseText);
          datosContainer.html(`<p>Error al cargar los datos: ${xhr.status} - ${xhr.responseText || error}</p>`);
        }
      });
    } else {
      datosContainer.html('<p>Selecciona una fecha para ver los datos.</p>');
    }
  }

  function prellenarFormularioEdicion(fecha, data) {
    // Establecer la fecha en el campo oculto
    $('#edit_fecha').val(fecha);

    // Prellenar los campos del formulario
    $('#edit_peso').val(data.peso || '');
    $('#edit_perimetro_pecho').val(data.perimetro_pecho || '');
    $('#edit_indice_grasa_corporal').val(data.indice_grasa_corporal || '');
    $('#edit_masa_muscular').val(data.masa_muscular || '');
    $('#edit_agua_corporal').val(data.agua_corporal || '');
    $('#edit_perimetro_cintura').val(data.perimetro_cintura || '');
    $('#edit_perimetro_cadera').val(data.perimetro_cadera || '');
    $('#edit_perimetro_muslo').val(data.perimetro_muslo || '');
    $('#edit_perimetro_brazo').val(data.perimetro_brazo || '');
    $('#edit_tension_arterial_maxima').val(data.tension_arterial_maxima || '');
    $('#edit_tension_arterial_minima').val(data.tension_arterial_minima || '');
    $('#edit_comentario').val(data.comentario || '');
  }

  $(document).ready(function () {
    $('.selectpicker').selectpicker();
  });
</script>

<!-- <script>
  function printPlanNutricional() {
    const planContent = document.querySelector('#plan-nutricional-content .content-card').innerHTML;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html>
        <head>
          <title>Imprimir Plan Nutricional</title>
          <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
          <style>
            body { font-family: 'Inter', sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #ccc; padding: 8px; vertical-align: top; }
            th { background-color: #f2f2f2; }
            .meal-option { margin-bottom: 10px; }
            .meal-option strong { display: block; font-weight: bold; }
            ul { padding-left: 20px; }
          </style>
        </head>
        <body>
          <h2>Plan Nutricional</h2>
          ${planContent}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 500); // Esperar que se cargue todo
  }
</script> -->

<script>
function printPlanNutricional() {
  const planContent = document.querySelector('#plan-nutricional-content .content-card');

  // Clonamos el contenido original
  const cloned = planContent.cloneNode(true);

  // Tomamos la recomendación si existe
  // const recomendacionElem = document.getElementById('recomendacion-impresion');
  // const recomendacionHTML = recomendacionElem ? recomendacionElem.outerHTML : '';

  // Reemplazar opciones OP1, OP2, OP3 por texto plano con '+'
  const cells = cloned.querySelectorAll('.nutrition-meal');
  cells.forEach(cell => {
    const platos = [];
    cell.querySelectorAll('li').forEach(li => {
      const texto = li.textContent.trim();
      if (texto && texto !== '-') {
        platos.push(texto);
      }
    });

    // Obtener descripción si hay
    const descripcion = cell.querySelector('small')?.textContent.trim();
    
    // Limpiar el contenido de la celda
    cell.innerHTML = '';

    // Agregar línea de platos
    if (platos.length > 0) {
      const p = document.createElement('p');
      p.textContent = platos.join(' + ');
      cell.appendChild(p);
    } else {
      cell.innerHTML = '<p>-</p>';
    }

    // Agregar la descripción si existe
    if (descripcion) {
      const small = document.createElement('p');
      small.textContent = `Descripción: ${descripcion}`;
      small.style.fontStyle = 'italic';
      small.style.fontSize = '11px';
      small.style.marginTop = '4px';
      small.style.color = '#666';
      cell.appendChild(small);
    }
  });

  // Imprimir contenido modificado
  const htmlContent = `
    <html>
      <head>
        <title>Plan Nutricional</title>
        <style>
          body { font-family: 'Inter', sans-serif; padding: 20px; }
          table { width: 100%; border-collapse: collapse; font-size: 12px; }
          th, td { border: 1px solid #ccc; padding: 8px; vertical-align: top; }
          th { background-color: #f2f2f2; }
          th:first-child, td:first-child { width: 60px; }
          p { margin: 0 0 5px; display: inline-block; }
          strong { display: block; margin-bottom: 5px; }
        </style>
      </head>
      <body>
        <h2>Plan Nutricional</h2>
        ${cloned.innerHTML}
      </body>
    </html>
  `;

  const printWindow = window.open('', '_blank');
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 500);
}

</script>

<!-- Incluye este script antes del cierre del body -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const numericFields = document.querySelectorAll("input[data-type='numeric']");
    numericFields.forEach(field => {
      field.addEventListener('input', () => {
        const value = field.value;
        const valid = /^\d+(\.\d{0,2})?$/.test(value);
        if (!valid && value !== "") {
          field.setCustomValidity("Solo se permiten números con hasta dos decimales.");
        } else {
          field.setCustomValidity("");
        }
      });
    });
  });

  document.addEventListener('DOMContentLoaded', function () {
    // Cuando se abre el modal, configurar la URL del formulario
    $('#confirmarEliminarPlanModal').on('show.bs.modal', function (event) {
      const button = $(event.relatedTarget); // Botón que abrió el modal
      const planId = button.data('plan-id'); // Obtener el ID del plan
      const form = $('#eliminarPlanForm');
      
      // Configurar la acción del formulario dinámicamente
      form.attr('action', `/plannutricional/eliminar_plan_nutricional/${planId}/`);
    });
  });

  
</script>


{% endblock %}